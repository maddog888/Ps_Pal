<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="./favicon.ico" type="image/x-icon" />
    <title>åˆ›å»ºæ‰“èµ - Ps Pal</title>
    <link rel="stylesheet" href="./assets/style.css">
</head>
<body>
    <div class="container" style="display: inline-block;">
        <form action="./PsPal.html" onsubmit="return handleFormSubmit(event);" class="card-container">
            <h2><font color="#58bf6a">åˆ›å»ºæ‰“èµ - ä»…ä¾›æ¼”ç¤º</font></h2>
            <div style="font-size: 80%;">
                æ‰“èµå·:
                <input id="no" name="no" />
                &nbsp;&nbsp;&nbsp;
                æ‰“èµé‡‘é¢:
                <input id="price" name="price" />
            </div>
            <br />
            <div style="font-size: 80%;">
                åŒæ­¥å›è°ƒ:
                <input id="rurl" name="rurl" />
                &nbsp;&nbsp;&nbsp;
                å¼‚æ­¥å›è°ƒ:
                <input id="nurl" name="nurl" />
            </div>
            <br />
            <div style="font-size: 80%;">
                é€šä¿¡ç§˜é’¥:
                <input value="123456" id="key" name="key" />
                <input id="sign" name="sign" hidden />
                &nbsp;&nbsp;&nbsp;
                <button>æäº¤åˆ›å»º</button>
            </div>
        </form>
    </div>
    <div style="font-size: 0.9rem;">
        Copyright Â© MadDog | <a target="_blank" href="https://github.com/maddog888/ps_pal/">Ps_Palé¡¹ç›®æºç </a>
    </div>
</body>
<script>
    // æ³¨æ„ï¼ï¼ï¼
    // è¯¥é¡µé¢ä»…ä¾›æ¼”ç¤ºï¼Œå»ºè®®ä½¿ç”¨åç«¯ä»£ç å®ç°åˆ›å»º
    // ğŸ‘†ğŸ»ğŸ‘†ğŸ»ğŸ‘†ğŸ»ğŸ‘†ğŸ»ğŸ‘†ğŸ»ğŸ‘†ğŸ»ğŸ‘†ğŸ»ğŸ‘†ğŸ»ğŸ‘†ğŸ»ğŸ‘†ğŸ»ğŸ‘†ğŸ»ğŸ‘†ğŸ»ğŸ‘†ğŸ»ğŸ‘†ğŸ»ğŸ‘†ğŸ»ğŸ‘†ğŸ»ğŸ‘†ğŸ»ğŸ‘†ğŸ»ğŸ‘†ğŸ»ğŸ‘†ğŸ»

    // è·å–å½“å‰æ—¶é—´å¹¶è½¬æ¢ä¸ºçº¯æ•°å­—
    const now = new Date();
    const currentTime = now.getFullYear() + String(now.getMonth()+1) + String(now.getDate());
    // ç”Ÿæˆ5ä½éšæœºæ•°
    const randomNum = Math.floor(100000 + Math.random() * 900000);
    
    // è®¾ç½®æ‰“èµå·
    var no = document.getElementById('no');
    no.value = currentTime + randomNum;

    // è®¾ç½®æ‰“èµé‡‘é¢ä¸º1åˆ°10ä¹‹é—´çš„éšæœºæ•´æ•°
    var price = document.getElementById('price');
    price.value = String(Math.floor(Math.random() * 10) + 1)+'.00';

    // è·å–å½“å‰åŸŸååœ°å€
    const currentUrl = window.location.href;

    // è®¾ç½®åŒæ­¥å’Œå¼‚æ­¥å›è°ƒURL
    var rurl = document.getElementById('rurl');
    rurl.value = currentUrl;
    var nurl = document.getElementById('nurl');
    nurl.value = currentUrl;

    // åˆå§‹åŒ–é€šä¿¡ç§˜é’¥å’ŒSign
    var key = document.getElementById('key');
    var sign = document.getElementById('sign');

    async function handleFormSubmit(event) {
        event.preventDefault(); // é˜»æ­¢è¡¨å•çš„é»˜è®¤æäº¤è¡Œä¸º
        
        // ç­¾åç”Ÿæˆ
        const result = await generateSignature();
        
        // ç­¾åæˆåŠŸ
        if (result) {
            // èµ‹å€¼ç­¾åæ•°æ®
            sign.value = result;
            // æäº¤è¡¨å•
            event.target.submit();
        }
    }

    // å®šä¹‰ä¸€ä¸ªå¼‚æ­¥å‡½æ•°æ¥å¤„ç†ç­¾åçš„ç”Ÿæˆ
    async function generateSignature() {
        // ç»„æˆç­¾åæ•°æ®
        let signText = no.value + price.value + nurl.value + key.value;
        console.log(signText);
        
        const hash = await sha256(signText);
        console.log(`SHA-256 hash: ${hash}`);
        return hash;
    }

    // sha256ç­¾åå‡½æ•°
    async function sha256(message) {
        // å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºUint8Array
        const msgBuffer = new TextEncoder().encode(message);
        
        // ä½¿ç”¨crypto.subtle.digest()ç”Ÿæˆå“ˆå¸Œ
        const hashBuffer = await window.crypto.subtle.digest('SHA-256', msgBuffer);
        
        // å°† ArrayBuffer è½¬æ¢æˆ Uint8Arrayï¼Œç„¶åè½¬æ¢ä¸ºåå…­è¿›åˆ¶å­—ç¬¦ä¸²
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        
        return hashHex;
    }
</script>
</html>